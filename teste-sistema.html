<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste do Sistema Local</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste do Sistema Local</h1>
        
        <div class="test-section info">
            <h3>Status do Sistema</h3>
            <p id="systemStatus">Verificando...</p>
        </div>

        <div class="test-section">
            <h3>Teste de Login</h3>
            <button onclick="testarLogin()">Testar Login Admin</button>
            <div id="loginResult"></div>
        </div>

        <div class="test-section">
            <h3>Teste de Dados</h3>
            <button onclick="testarDados()">Verificar Dados</button>
            <div id="dadosResult"></div>
        </div>

        <div class="test-section">
            <h3>Teste de API</h3>
            <button onclick="testarAPI()">Testar Chamadas de API</button>
            <div id="apiResult"></div>
        </div>

        <div class="test-section">
            <h3>Teste de Recupera√ß√£o de Senha</h3>
            <button onclick="testarRecuperacao()">Testar Recupera√ß√£o</button>
            <div id="recuperacaoResult"></div>
        </div>

        <div class="test-section">
            <h3>Teste de CAPTCHA</h3>
            <button onclick="testarCaptcha()">Testar CAPTCHA</button>
            <div id="captchaResult"></div>
        </div>

        <div class="test-section">
            <h3>Links √öteis</h3>
            <button onclick="window.location.href='teste-captcha.html'">Teste CAPTCHA</button>
            <button onclick="window.location.href='ajuda-recuperacao.html'">Ajuda Recupera√ß√£o</button>
            <button onclick="window.location.href='esqueci-senha.html'">P√°gina Recupera√ß√£o</button>
            <button onclick="window.location.href='cadastro.html'">Cadastro</button>
        </div>

        <div class="test-section">
            <h3>Console de Debug</h3>
            <div id="debugConsole" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border: 1px solid #ddd;"></div>
        </div>
    </div>

    <!-- Sistema de Banco Local -->
    <script src="js/local-database.js"></script>
    <script src="js/captcha.js"></script>

    <script>
        // Interceptar console.log para mostrar no debug
        const originalLog = console.log;
        const debugDiv = document.getElementById('debugConsole');
        
        console.log = function(...args) {
            originalLog.apply(console, arguments);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEntry.style.marginBottom = '5px';
            debugDiv.appendChild(logEntry);
            debugDiv.scrollTop = debugDiv.scrollHeight;
        };

        // Verificar status do sistema
        function verificarSistema() {
            const status = document.getElementById('systemStatus');
            
            if (typeof localDB !== 'undefined') {
                status.innerHTML = '‚úÖ Banco local carregado<br>‚úÖ localStorage dispon√≠vel<br>‚úÖ Sistema funcionando';
                status.parentElement.className = 'test-section success';
            } else {
                status.innerHTML = '‚ùå Banco local n√£o carregado';
                status.parentElement.className = 'test-section error';
            }
        }

        // Testar login
        async function testarLogin() {
            const result = document.getElementById('loginResult');
            result.innerHTML = 'Testando login...';
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@escola.com',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML = `<div class="success">‚úÖ Login funcionando!<br><pre>${JSON.stringify(data, null, 2)}</pre></div>`;
                } else {
                    result.innerHTML = `<div class="error">‚ùå Erro no login: ${data.error}</div>`;
                }
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }

        // Testar dados
        function testarDados() {
            const result = document.getElementById('dadosResult');
            
            if (typeof localDB === 'undefined') {
                result.innerHTML = '<div class="error">‚ùå Banco local n√£o dispon√≠vel</div>';
                return;
            }
            
            const alunos = localDB.getAll('alunos');
            const professores = localDB.getAll('professores');
            const turmas = localDB.getAll('turmas');
            const usuarios = localDB.getAll('usuarios');
            
            result.innerHTML = `
                <div class="success">
                    ‚úÖ Dados carregados:<br>
                    ‚Ä¢ ${alunos.length} alunos<br>
                    ‚Ä¢ ${professores.length} professores<br>
                    ‚Ä¢ ${turmas.length} turmas<br>
                    ‚Ä¢ ${usuarios.length} usu√°rios
                </div>
            `;
        }

        // Testar API
        async function testarAPI() {
            const result = document.getElementById('apiResult');
            result.innerHTML = 'Testando APIs...';
            
            const testes = [
                { url: '/api/stats', nome: 'Estat√≠sticas' },
                { url: '/api/alunos', nome: 'Lista de Alunos' },
                { url: '/api/professores', nome: 'Lista de Professores' },
                { url: '/api/atividades', nome: 'Atividades Recentes' }
            ];
            
            let resultados = [];
            
            for (const teste of testes) {
                try {
                    const response = await fetch(teste.url);
                    const data = await response.json();
                    
                    if (response.ok) {
                        resultados.push(`‚úÖ ${teste.nome}: OK (${Array.isArray(data) ? data.length + ' itens' : 'dados carregados'})`);
                    } else {
                        resultados.push(`‚ùå ${teste.nome}: Erro`);
                    }
                } catch (error) {
                    resultados.push(`‚ùå ${teste.nome}: ${error.message}`);
                }
            }
            
            result.innerHTML = `<div class="info">${resultados.join('<br>')}</div>`;
        }

        // Testar CAPTCHA
        function testarCaptcha() {
            const result = document.getElementById('captchaResult');
            
            if (typeof captchaManager === 'undefined') {
                result.innerHTML = '<div class="error">‚ùå Sistema de CAPTCHA n√£o carregado</div>';
                return;
            }
            
            try {
                // Testar gera√ß√£o de CAPTCHA
                const mathCaptcha = captchaManager.generateCaptcha('math');
                const textCaptcha = captchaManager.generateCaptcha('text');
                const patternCaptcha = captchaManager.generateCaptcha('pattern');
                
                result.innerHTML = `
                    <div class="success">
                        ‚úÖ Sistema de CAPTCHA funcionando!<br>
                        <strong>Tipos dispon√≠veis:</strong><br>
                        üßÆ Matem√°tico: ${mathCaptcha.question}<br>
                        üìù Texto: ${textCaptcha.answer}<br>
                        üé® Padr√£o: ${patternCaptcha.options.length} op√ß√µes<br><br>
                        <button onclick="window.location.href='teste-captcha.html'">Testar Detalhado</button>
                    </div>
                `;
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå Erro no CAPTCHA: ${error.message}</div>`;
            }
        }

        // Testar recupera√ß√£o de senha
        function testarRecuperacao() {
            const result = document.getElementById('recuperacaoResult');
            
            if (typeof localDB === 'undefined') {
                result.innerHTML = '<div class="error">‚ùå Banco local n√£o dispon√≠vel</div>';
                return;
            }
            
            const usuarios = localDB.getAll('usuarios');
            
            if (usuarios.length === 0) {
                result.innerHTML = '<div class="error">‚ùå Nenhum usu√°rio cadastrado</div>';
                return;
            }
            
            const admin = usuarios.find(u => u.email === 'admin@escola.com');
            
            if (admin) {
                result.innerHTML = `
                    <div class="success">
                        ‚úÖ Sistema de recupera√ß√£o dispon√≠vel!<br>
                        <strong>Teste com:</strong><br>
                        Email: admin@escola.com<br>
                        Pergunta: Qual o nome da sua primeira escola?<br>
                        Resposta: escola primaria<br><br>
                        <button onclick="window.location.href='esqueci-senha.html'">Testar Agora</button>
                    </div>
                `;
            } else {
                result.innerHTML = '<div class="error">‚ùå Usu√°rio admin n√£o encontrado</div>';
            }
        }

        // Inicializar testes
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                verificarSistema();
                console.log('üß™ Sistema de testes carregado');
            }, 1000);
        });
    </script>
</body>
</html>